{% extends "gestionale/base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<h1 class="h2 mb-4">{{ title }}</h1>

<div class="card">
    <div class="card-body">
        <form method="post">
            {% csrf_token %}

            <!-- Mostra eventuali errori non legati a un campo specifico (es. validazione 'clean') -->
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Usiamo il nostro partial per renderizzare i campi in modo pulito -->
            <div id="container_data">{% include "gestionale/partials/_form_field.html" with field=form.data_registrazione %}</div>
            <div id="container_descrizione">{% include "gestionale/partials/_form_field.html" with field=form.descrizione %}</div>
            
            <div class="row">
                <div class="col-md-6" id="container_tipo_movimento">{% include "gestionale/partials/_form_field.html" with field=form.tipo_movimento %}</div>
                <div class="col-md-6" id="container_importo">{% include "gestionale/partials/_form_field.html" with field=form.importo %}</div>
            </div>
            
            <div class="row">
                <div class="col-md-6">{% include "gestionale/partials/_form_field.html" with field=form.causale %}</div>
                <div class="col-md-6" id="container_conto_finanziario">{% include "gestionale/partials/_form_field.html" with field=form.conto_finanziario %}</div>
            </div>
            
            <!-- Campo speciale per il Giroconto -->
            <div id="container_conto_destinazione" style="display: none;">
                {% include "gestionale/partials/_form_field.html" with field=form.conto_destinazione %}
            </div>
            
            <hr>
            <div id="container_dati_opzionali">
                <p class="text-muted">Dati Opzionali</p>
                <div class="row">
                    <div class="col-md-4">{% include "gestionale/partials/_form_field.html" with field=form.conto_operativo %}</div>
                    <div class="col-md-4">{% include "gestionale/partials/_form_field.html" with field=form.anagrafica %}</div>
                    <div class="col-md-4">{% include "gestionale/partials/_form_field.html" with field=form.cantiere %}</div>
                </div>
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary">Salva Movimento</button>
                <a href="{% url 'primanota_list' %}" class="btn btn-secondary">Annulla</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // === SETUP ===
    const causaleSelect = document.getElementById('id_causale');
    // La mappa delle proprietà delle causali che arriva dalla vista
    const causaliData = JSON.parse('{{ causali_data_json|safe|default:"{}" }}');

    // Selezioniamo tutti gli elementi che dobbiamo manipolare
    const tipoMovimentoInput = document.getElementById('id_tipo_movimento');
    const contoDestinazioneContainer = document.getElementById('container_conto_destinazione');
    const contoDestinazioneInput = document.getElementById('id_conto_destinazione');
    const datiOpzionaliContainer = document.getElementById('container_dati_opzionali');
    
    // Lista dei campi opzionali da disabilitare/abilitare
    const opzionaliInputs = datiOpzionaliContainer.querySelectorAll('select');

    // === FUNZIONE DI AGGIORNAMENTO UI ===
    function aggiornaFormInBaseAllaCausale() {
        const causaleId = causaleSelect.value;
        const causaleSelezionata = causaliData[causaleId];

        // Se non abbiamo informazioni sulla causale, mostriamo tutto di default
        if (!causaleSelezionata) {
            contoDestinazioneContainer.style.display = 'none';
            datiOpzionaliContainer.style.display = 'block';
            tipoMovimentoInput.disabled = false;
            opzionaliInputs.forEach(i => i.disabled = false);
            return;
        }

        const tipoDefault = causaleSelezionata.tipo;
        const isGiroconto = tipoDefault === 'M';

        // --- Logica Giroconto ---
        contoDestinazioneContainer.style.display = isGiroconto ? 'block' : 'none';
        contoDestinazioneInput.required = isGiroconto;

        // --- Logica Campi Nascosti/Disabilitati ---
        datiOpzionaliContainer.style.display = isGiroconto ? 'none' : 'block';
        opzionaliInputs.forEach(i => i.disabled = isGiroconto);
        tipoMovimentoInput.disabled = isGiroconto;
        
        // --- Logica Pre-Compilazione Automatica ---
        if (isGiroconto) {
            // Per i giroconti, il tipo è implicito, lo svuotiamo per sicurezza
            tipoMovimentoInput.value = '';
        } else if (tipoDefault) {
            // Se la causale ha un tipo di default (E o U), lo pre-selezioniamo
            tipoMovimentoInput.value = tipoDefault;
        }
    }
    
    // === AGGANCIO EVENTO ===
    causaleSelect.addEventListener('change', aggiornaFormInBaseAllaCausale);
    
    // Esegui la funzione una volta al caricamento per impostare lo stato iniziale del form
    aggiornaFormInBaseAllaCausale();
});
</script>
{% endblock %}