{% extends "gestionale/base.html" %}
{% load currency_filters humanize %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<h1 class="h2 mb-4">Dashboard Riepilogativa</h1>

<!-- ======================= NUOVA PRIMA RIGA KPI: SINTESI STRATEGICA ======================= -->
<div class="row">
    <!-- 1. Posizione Finanziaria Netta -->
    <div class="col-md-6 col-xl-3 mb-4">
        <div class="card h-100 shadow-sm">
            <div class="card-body d-flex flex-column">
                <h6 class="card-title text-muted">Posizione Fin. Netta</h6>
                <h3 class="fw-bold mt-auto {% if kpi_finanziari.saldo_netto < 0 %}text-danger{% endif %}">
                    € {{ kpi_finanziari.saldo_netto|format_currency }}
                </h3>
                <small class="text-muted">(Crediti - Debiti)</small>
            </div>
        </div>
    </div>
    <!-- 2. Liquidità Totale -->
    <div class="col-md-6 col-xl-3 mb-4">
        <div class="card h-100 shadow-sm">
            <div class="card-body d-flex flex-column">
                <h6 class="card-title text-muted">Liquidità Totale</h6>
                <h3 class="fw-bold mt-auto {% if kpi_finanziari.liquidita_totale < 0 %}text-danger{% endif %}">
                    <a href="{% url 'tesoreria_dashboard' %}" class="text-dark text-decoration-none {% if kpi_finanziari.liquidita_totale < 0 %}text-danger{% endif %}">
                        € {{ kpi_finanziari.liquidita_totale|format_currency }}
                    </a>
                </h3>
                <small class="text-muted">(Somma saldi conti finanziari)</small>
            </div>
        </div>
    </div>
    <!-- 3. Fatturato Netto YTD -->
    <div class="col-md-6 col-xl-3 mb-4">
        <div class="card h-100 shadow-sm">
            <div class="card-body d-flex flex-column">
                <h6 class="card-title text-muted">Fatturato Netto YTD</h6>
                <h3 class="fw-bold mt-auto {% if kpi_economici_e_anagrafici.fatturato_netto_ytd < 0 %}text-danger{% else %}text-success{% endif %}">
                    € {{ kpi_economici_e_anagrafici.fatturato_netto_ytd|format_currency }}
                </h3>
                <small class="text-muted">(Fatturato Attivo - Passivo)</small>
            </div>
        </div>
    </div>
    <!-- 4. Risultato Economico YTD -->
    <div class="col-md-6 col-xl-3 mb-4">
        <div class="card h-100 shadow-sm">
            <div class="card-body d-flex flex-column">
                <h6 class="card-title text-muted">Risultato Economico YTD</h6>
                <h3 class="fw-bold mt-auto {% if kpi_economici_e_anagrafici.risultato_economico_ytd < 0 %}text-danger{% else %}text-success{% endif %}">
                    € {{ kpi_economici_e_anagrafici.risultato_economico_ytd|format_currency }}
                </h3>
                <small class="text-muted">(Ricavi - Costi)</small>
            </div>
        </div>
    </div>
</div>

<!-- ======================= NUOVA SECONDA RIGA KPI: DETTAGLIO OPERATIVO ======================= -->
<div class="row">
    <!-- 1. Crediti v/Clienti -->
    <div class="col-md-6 col-xl-3 mb-4">
        <div class="card h-100 shadow-sm">
            <div class="card-body d-flex flex-column">
                <h6 class="card-title text-muted">Crediti v/Clienti (Aperto)</h6>
                <h3 class="fw-bold text-success mt-auto">
                    <a href="{% url 'scadenzario_list' %}?tipo=Incasso" class="text-success text-decoration-none">
                        € {{ kpi_finanziari.crediti_clienti|format_currency }}
                    </a>
                </h3>
                <small class="text-muted">(di cui scaduti: 
                    <a href="{% url 'scadenzario_list' %}?tipo=Incasso&stato=scadute">
                        € {{ kpi_finanziari.crediti_scaduti|format_currency }}
                    </a>)
                </small>
            </div>
        </div>
    </div>
    <!-- 2. Debiti v/Fornitori -->
    <div class="col-md-6 col-xl-3 mb-4">
        <div class="card h-100 shadow-sm">
            <div class="card-body d-flex flex-column">
                <h6 class="card-title text-muted">Debiti v/Fornitori (Aperto)</h6>
                <h3 class="fw-bold text-danger mt-auto">
                    <a href="{% url 'scadenzario_list' %}?tipo=Pagamento" class="text-danger text-decoration-none">
                        € {{ kpi_finanziari.debiti_fornitori|format_currency }}
                    </a>
                </h3>
                <small class="text-muted">(di cui scaduti: 
                    <a href="{% url 'scadenzario_list' %}?tipo=Pagamento&stato=scadute">
                        € {{ kpi_finanziari.debiti_scaduti|format_currency }}
                    </a>)
                </small>
            </div>
        </div>
    </div>
    <!-- 3. Cash Flow YTD -->
    <div class="col-md-6 col-xl-3 mb-4">
        <div class="card h-100 shadow-sm">
            <div class="card-body d-flex flex-column">
                <h6 class="card-title text-muted">Cash Flow YTD</h6>
                <h3 class="fw-bold mt-auto {% if kpi_economici_e_anagrafici.cash_flow_ytd < 0 %}text-danger{% else %}text-success{% endif %}">
                    € {{ kpi_economici_e_anagrafici.cash_flow_ytd|format_currency }}
                </h3>
                <small class="text-muted">(Entrate - Uscite)</small>
            </div>
        </div>
    </div>
    <!-- 4. Anagrafiche Attive -->
    <div class="col-md-6 col-xl-3 mb-4">
        <div class="card h-100 shadow-sm">
            <div class="card-body">
                <h6 class="card-title text-muted mb-3">Anagrafiche Attive</h6>
                <ul class="list-unstyled">
                    <li class="d-flex justify-content-between">
                        <a href="{% url 'anagrafica_list' %}?tipo=Cliente">Clienti:</a> 
                        <span class="fw-bold">{{ kpi_economici_e_anagrafici.anagrafiche.clienti }}</span>
                    </li>
                    <li class="d-flex justify-content-between">
                        <a href="{% url 'anagrafica_list' %}?tipo=Fornitore">Fornitori:</a>
                        <span class="fw-bold">{{ kpi_economici_e_anagrafici.anagrafiche.fornitori }}</span>
                    </li>
                    <li class="d-flex justify-content-between">
                        <a href="{% url 'anagrafica_list' %}?tipo=Dipendente">Dipendenti:</a>
                        <span class="fw-bold">{{ kpi_economici_e_anagrafici.anagrafiche.dipendenti }}</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- ======================= WIDGET MARGINE CANTIERI, SALDI E SCADENZE ======================= -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card h-100 shadow-sm">
            <div class="card-header fw-bold">Margine Cantieri Aperti</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Cantiere</th>
                                <th class="text-end">Ricavi</th>
                                <th class="text-end">Costi</th>
                                <th class="text-end">Margine</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cantiere in cantieri_con_margine %}
                            <tr>
                                <td><a href="{% url 'cantiere_detail' cantiere.pk %}">{{ cantiere.codice_cantiere|truncatechars:25 }}</a></td>
                                <td class="text-end text-success">{{ cantiere.ricavi_totali|format_currency }}</td>
                                <td class="text-end text-danger">{{ cantiere.costi_totali|format_currency }}</td>
                                <td class="text-end fw-bold {% if cantiere.margine < 0 %}text-danger{% else %}text-success{% endif %}">
                                    {{ cantiere.margine|format_currency }}
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center text-muted">Nessun cantiere aperto con movimenti registrati.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer text-end">
                <a href="{% url 'dashboard_hr' %}">Vai a Gestione Cantieri →</a>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card h-100 shadow-sm">
            <div class="card-header fw-bold">Saldi Conti Finanziari</div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    {% for conto in conti_finanziari %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <a href="{% url 'primanota_list' %}?conto_finanziario={{ conto.pk }}">{{ conto.nome_conto }}</a>
                        <span class="fw-bold {% if conto.saldo < 0 %}text-danger{% endif %}">€ {{ conto.saldo|format_currency }}</span>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-center text-muted">Nessun conto finanziario attivo.</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="card-footer text-end">
                <a href="{% url 'tesoreria_dashboard' %}">Vai alla Gestione Tesoreria →</a>
            </div>
        </div>
    </div>
</div>

<!-- ======================= WIDGET SCADENZE e HR ======================= -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card h-100 shadow-sm">
            <div class="card-header fw-bold">Scadenze Imminenti (60 gg)</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr><th>Data</th><th>Tipo</th><th>Anagrafica</th><th class="text-end">Residuo</th></tr>
                        </thead>
                        <tbody>
                            {% for scadenza in scadenze_imminenti %}
                            <tr>
                                <td>{{ scadenza.data_scadenza|date:"d/m/y" }}</td>
                                <td>
                                    {% if scadenza.tipo_scadenza == 'Incasso' %}
                                        <span class="badge bg-success-subtle text-success-emphasis rounded-pill">Incasso</span>
                                    {% else %}
                                        <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill">Pagamento</span>
                                    {% endif %}
                                </td>
                                <td><a href="{% url 'anagrafica_detail' scadenza.anagrafica.pk %}">{{ scadenza.anagrafica.nome_cognome_ragione_sociale|truncatechars:20 }}</a></td>
                                <td class="text-end fw-bold {% if scadenza.tipo_scadenza == 'Pagamento' %}text-danger{% endif %}">€ {{ scadenza.residuo|format_currency }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center text-muted">Nessuna scadenza imminente.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer text-end">
                <a href="{% url 'scadenzario_list' %}">Vai allo Scadenziario Completo →</a>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card h-100 shadow-sm">
            <div class="card-header fw-bold">Riepilogo Operativo Odierno</div>
            <div class="card-body text-center d-flex flex-column justify-content-center">
                 <a href="{% url 'dashboard_hr' %}" class="text-decoration-none text-dark">
                    <h2 class="display-4 fw-bold">{{ kpi_operativi.dipendenti_presenti }} / {{ kpi_operativi.totale_dipendenti }}</h2>
                    <p class="text-muted mb-0">Dipendenti Presenti</p>
                </a>
                <hr>
                <div class="row">
                    <div class="col-6">
                        <h3 class="fw-bold">{{ kpi_operativi.cantieri_attivi }}</h3>
                        <p class="text-muted mb-0">Cantieri Attivi</p>
                    </div>
                    <div class="col-6">
                        <h3 class="fw-bold">{{ kpi_operativi.note_spese_pendenti }}</h3>
                        <p class="text-muted mb-0">Note Spese Pendenti</p>
                    </div>
                </div>
            </div>
            <div class="card-footer text-end">
                <a href="{% url 'dashboard_hr' %}">Vai al Planning Giornaliero →</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}